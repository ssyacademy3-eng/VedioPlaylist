<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YouTube Playlist UI</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
/* --- SAME STYLING AS BEFORE --- */
:root {
  --primary: linear-gradient(135deg,#0a0057,#3f00ee);
  --playlist-bg: #FFD700;
  --active-title: #0a0057;
  --progress: #3f00ee;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{width:100%;font-family:'Poppins',sans-serif;background:var(--primary);color:#000;overflow-x:hidden;}
main.container{display:flex;flex-direction:row;gap:1rem;padding:1rem;max-width:1400px;margin:0 auto;}
section{border-radius:10px;padding:1rem;flex:1;min-width:0;}
.main-video{flex:2;display:flex;flex-direction:column;align-items:center;width:100%;}
.video-frame{position:relative;width:100%;height:650px;border-radius:10px;overflow:hidden;} 
.video-frame iframe{width:100%;height:100%;}
.video-title{margin:0.5rem 0;text-align:center;font-size:1.3rem;font-weight:bold;color:#fff;}
.video-controls{display:flex;justify-content:center;gap:1rem;margin:0.5rem 0;}
.video-controls button{background: var(--playlist-bg);border:none;color:#000;font-size:1.2rem;padding:0.6rem 1.2rem;border-radius:8px;cursor:pointer;font-weight:bold;transition:0.3s;}
.video-controls button:hover{background:#ffea00;}
.progress-overlay{position:relative;width:100%;height:10px;background:rgba(0,0,0,0.2);border-radius:10px;margin-bottom:0.5rem;cursor:pointer;}
.progress-bar{width:0%;height:100%;background:var(--progress);border-radius:10px;box-shadow:0 0 10px var(--progress);}
.video-playlist{flex:1;display:flex;flex-direction:column;background:var(--playlist-bg);border-radius:10px;padding:0.5rem;margin-top:0.5rem;}
.video-playlist .title{font-size:1.1rem;color:#000;margin-bottom:0.3rem;}
.video-playlist>p{color:#000;font-size:0.9rem;margin-bottom:0.7rem;}
.videos{overflow-y:auto;flex:1;max-height:70vh;display:flex;flex-direction:column;gap:0.2rem;}
.video-item{display:flex;align-items:center;gap:0.6rem;padding:0.6rem;border-radius:8px;transition:0.3s;cursor:pointer;background:#fff;color:#000;}
.video-item:hover{background:#ffe066;}
.video-item.active{background:#ffec99;color:var(--active-title);}
.video-item.active h3{color:var(--active-title);}
.video-item i{font-size:18px;width:24px;text-align:center;color:#000;}
.video-item.active i{color:var(--active-title);}
.video-item h3{font-size:0.9rem;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.video-item .time{font-size:0.85rem;opacity:0.8;flex-shrink:0;}
.videos::-webkit-scrollbar{width:4px;}
.videos::-webkit-scrollbar-thumb{background:#000;border-radius:4px;}

@media(max-width:900px){
  main.container{flex-direction:column;padding:0.5rem;}
  .main-video{width:100%;}
  .video-frame{width:100vw; height:55vh;}
  .video-playlist{width:100%;margin-top:0.5rem;}
  .videos{max-height:35vh;}
}
@media(max-width:600px){
  .video-frame{height:50vh;}
  .video-title{font-size:1.2rem;}
  .video-item h3{font-size:0.85rem;}
  .video-item i{font-size:16px;}
}
@media(max-width:400px){
  .video-frame{height:45vh;}
  .video-playlist>p{font-size:0.8rem;}
  .video-item h3{font-size:0.8rem;}
  .video-item .time{font-size:0.75rem;}
}
</style>
</head>
<body>

<main class="container">
  <section class="main-video">
    <div class="video-frame" id="videoFrameContainer">
      <div id="player"></div>
    </div>

    <div class="video-controls">
      <button id="prev">Prev</button>
      <button id="next">Next</button>
    </div>
    <div class="progress-overlay"><div class="progress-bar"></div></div>
    <h3 class="video-title" id="mainTitle">Video Title</h3>
  </section>

  <section class="video-playlist">
    <h3 class="title">Lessons</h3>
    <p id="statusMsg">Loading Playlist...</p>
    <div class="videos" id="playlistContainer"></div>
  </section>
</main>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
// ==========================================
// SMART CONFIGURATION (Dynamic Tab Selector)
// ==========================================

const sheetID = '1WjQgGPmH9H77ZCjQOT6CTDCw4wxnwu7OgMYNF04RVz8'; 

// 1. Get the current URL parameters
const urlParams = new URLSearchParams(window.location.search);

// 2. Check if there is a "?gid=" number in the URL
// If yes, use it. If no, default to '0' (the first tab).
const sheetGID = urlParams.get('gid') || '0';

// 3. Construct the URL automatically
const sheetUrl = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:csv&gid=${sheetGID}`;

// ==========================================

let playlist = []; 
let currentIndex = 0;
let lastTime = 0;
let player;
let videoItems = [];

const playlistContainer = document.getElementById('playlistContainer');
const mainTitle = document.getElementById('mainTitle');
const progressBar = document.querySelector('.progress-bar');
const nextBtn = document.getElementById('next');
const prevBtn = document.getElementById('prev');
const statusMsg = document.getElementById('statusMsg');

// 1. Initialize App
async function initApp() {
  try {
    const response = await fetch(sheetUrl);
    if (!response.ok) throw new Error("Connection Failed.");
    
    const data = await response.text();
    
    // Check if we got a Login Page (Private Sheet)
    if(data.includes("<!DOCTYPE") || data.includes("<html")) {
        mainTitle.textContent = "Error: Sheet is Private";
        statusMsg.textContent = "Set 'Anyone with link'";
        return;
    }

    playlist = parseCSV(data);
    
    if (playlist.length > 0) {
      statusMsg.textContent = `${playlist.length} Lessons`;
      setupUI();
      if (window.YT && window.YT.Player) createPlayer();
    } else {
      mainTitle.textContent = "No videos found.";
      statusMsg.textContent = "Empty Sheet";
    }
  } catch (error) {
    console.error(error);
    mainTitle.textContent = "Connection Error";
  }
}

// 2. CSV Parser (Handles Quotes and Commas)
function parseCSV(csvText) {
  const lines = csvText.split('\n');
  const result = [];
  
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i].trim();
    if (!line) continue;
    
    // Split by comma but ignore commas inside quotes
    const parts = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
    if (!parts) continue;

    const cleanParts = parts.map(p => p.replace(/^"|"$/g, '').trim());

    // We expect: ID, Title, Duration
    if (cleanParts.length >= 2) {
      const id = cleanParts[0]; 
      
      // Filter out header rows like "ID" or "Video"
      if (id.toLowerCase() === "id" || id.length < 5) continue;

      const title = cleanParts[1]; 
      // Get duration from 3rd col or last col
      const duration = cleanParts.length > 2 ? cleanParts[cleanParts.length - 1] : "00:00";
      
      result.push({ id, title, duration });
    }
  }
  return result;
}

// 3. UI Setup
function setupUI() {
  playlistContainer.innerHTML = playlist.map((v, i) => `
    <div class="video-item" data-index="${i}">
      <i class="fa-solid fa-play"></i>
      <p>${String(i + 1).padStart(2, '0')}.</p>
      <h3>${v.title}</h3>
      <p class="time">${v.duration}</p>
    </div>
  `).join('');

  videoItems = document.querySelectorAll('.video-item');
  
  let savedIndex = parseInt(localStorage.getItem('lastVideoIndex')) || 0;
  if (savedIndex >= playlist.length) savedIndex = 0;
  currentIndex = savedIndex;
  lastTime = parseFloat(localStorage.getItem('lastVideoTime')) || 0;

  videoItems.forEach((v, i) => v.addEventListener('click', () => playVideo(i)));
}

// 4. YouTube Logic
function onYouTubeIframeAPIReady() {
  if (playlist.length > 0) createPlayer();
}

function createPlayer() {
  if(player) return;
  player = new YT.Player('player', {
    height: '100%',
    width: '100%',
    videoId: playlist[currentIndex].id,
    playerVars: {autoplay: 1, controls: 1, modestbranding: 1, rel: 0, fs: 1, iv_load_policy: 3},
    events: {
      'onReady': () => {
        player.seekTo(lastTime, true);
        highlightVideo(currentIndex);
        player.playVideo();
      },
      'onStateChange': onStateChange
    }
  });
}

function highlightVideo(index) {
  if(!videoItems.length) return;
  videoItems.forEach(v => {
    v.classList.remove('active');
    v.querySelector('i').classList.replace('fa-pause', 'fa-play');
    v.querySelector('h3').style.color = "#000";
  });
  if(videoItems[index]) {
    videoItems[index].classList.add('active');
    videoItems[index].querySelector('i').classList.replace('fa-play', 'fa-pause');
    videoItems[index].querySelector('h3').style.color = "var(--active-title)";
    mainTitle.textContent = playlist[index].title;
    videoItems[index].scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
}

function playVideo(index) {
  currentIndex = index;
  if(player && player.loadVideoById) player.loadVideoById(playlist[index].id);
  highlightVideo(index);
}

function onStateChange(event) {
  if (event.data === YT.PlayerState.ENDED) {
    currentIndex = (currentIndex + 1) % playlist.length;
    playVideo(currentIndex);
  }
}

nextBtn.addEventListener('click', () => {
  if(!playlist.length) return;
  currentIndex = (currentIndex + 1) % playlist.length;
  playVideo(currentIndex);
});

prevBtn.addEventListener('click', () => {
  if(!playlist.length) return;
  currentIndex = (currentIndex - 1 + playlist.length) % playlist.length;
  playVideo(currentIndex);
});

setInterval(() => {
  if (player && player.getCurrentTime) {
    const time = player.getCurrentTime();
    const duration = player.getDuration();
    if(duration) progressBar.style.width = ((time / duration) * 100) + '%';
    localStorage.setItem('lastVideoIndex', currentIndex);
    localStorage.setItem('lastVideoTime', time);
  }
}, 500);

initApp();
</script>
</body>
</html>
